name: Deploy SeeGap Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: eminent-subset-462023-f9
  GCP_VM_NAME: seegap-app-vm
  GCP_ZONE: europe-west1-b
  GCP_VM_IP: 34.140.57.52
  DEPLOY_PATH: /var/www/seegap

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/179814022008/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
        service_account: 'github-actions-deploy@eminent-subset-462023-f9.iam.gserviceaccount.com'
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: Install gcloud beta components
      run: |
        echo "ðŸ“¦ Installing gcloud beta components..."
        gcloud components install beta --quiet
        
    - name: Create deployment package
      run: |
        echo "ðŸ“¦ Creating deployment package..."
        mkdir -p /tmp/deploy
        rsync -av --exclude='.git' --exclude='.github' --exclude='node_modules' --exclude='*.log' --exclude='uploads/logs/*' --exclude='terraform' --exclude='backup_*' --exclude='test_*' --exclude='seegap-app.tar.gz' --exclude='docker*' --exclude='Dockerfile' . /tmp/deploy/
        cd /tmp/deploy
        tar -czf /tmp/seegap-app.tar.gz .
        mv /tmp/seegap-app.tar.gz $GITHUB_WORKSPACE/
        
    - name: Upload application files
      run: |
        echo "ðŸš€ Uploading application files to GCP VM..."
        gcloud beta compute scp seegap-app.tar.gz ${{ env.GCP_VM_NAME }}:~/ --zone=${{ env.GCP_ZONE }} --project=${{ env.GCP_PROJECT_ID }}
          
    - name: Create deployment script
      run: |
        cat > deploy.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸ”§ Starting deployment..."
        
        # Create backup of current deployment
        if [ -d "/var/www/html" ] && [ "$(ls -A /var/www/html 2>/dev/null)" ]; then
          echo "ðŸ“‹ Creating backup of current deployment..."
          sudo mkdir -p /var/backups/seegap
          sudo tar -czf /var/backups/seegap/backup-$(date +%Y%m%d-%H%M%S).tar.gz -C /var/www/html .
        fi
        
        echo "ðŸ“‚ Extracting new deployment..."
        mkdir -p /tmp/seegap-deploy
        cd /tmp/seegap-deploy
        tar -xzf ~/seegap-app.tar.gz
        
        echo "âš™ï¸ Creating production configuration..."
        cat > config.php << 'CONFIG_EOF'
        <?php
        /* Production Configuration for SeeGap Application - Nginx Deployment */
        define('DATABASE_SERVER',   'localhost');
        define('DATABASE_USERNAME', 'seegap_prod_user_2025');
        define('DATABASE_PASSWORD', 'SeeGap#Prod$2025!MySQL@Secure');
        define('DATABASE_NAME',     'seegap_production_db');
        define('SITE_URL',          'https://si.seegap.com/');

        /* Additional Production Settings */
        define('ENVIRONMENT', 'production');
        define('DEBUG_MODE', false);
        define('ERROR_REPORTING', false);

        /* Security Settings */
        define('SECURE_COOKIES', true);
        define('FORCE_HTTPS', true);

        /* Performance Settings */
        define('ENABLE_CACHING', true);
        define('CACHE_LIFETIME', 3600);

        /* File Upload Settings */
        define('MAX_UPLOAD_SIZE', '10M');
        define('ALLOWED_EXTENSIONS', 'jpg,jpeg,png,gif,webp,pdf,doc,docx');

        /* Logging Configuration */
        define('LOG_ERRORS', true);
        define('LOG_FILE', '/var/www/html/uploads/logs/application.log');

        /* Session Configuration */
        define('SESSION_LIFETIME', 86400);
        define('SESSION_NAME', 'SEEGAP_SESSION');

        /* API Configuration */
        define('API_RATE_LIMIT', 1000);
        define('API_VERSION', 'v1');

        /* Backup Configuration */
        define('BACKUP_ENABLED', true);
        define('BACKUP_RETENTION_DAYS', 30);

        /* Monitoring Configuration */
        define('HEALTH_CHECK_ENABLED', true);
        define('METRICS_ENABLED', true);

        /* Nginx-specific settings */
        define('WEB_SERVER', 'nginx');
        define('PHP_FPM_SOCKET', '/run/php/php8.1-fpm-seegap.sock');
        ?>
        CONFIG_EOF
        
        echo "ðŸš€ Deploying files to Docker web directory..."
        sudo mkdir -p /var/www/seegap
        sudo rsync -av --delete /tmp/seegap-deploy/ /var/www/seegap/
        
        echo "ðŸ”§ Setting proper file permissions..."
        sudo chown -R www-data:www-data /var/www/seegap
        sudo find /var/www/seegap -type d -exec chmod 755 {} \;
        sudo find /var/www/seegap -type f -exec chmod 644 {} \;
        sudo chmod -R 777 /var/www/seegap/uploads/
        
        echo "ðŸ”„ Checking deployment method..."
        if docker --version >/dev/null 2>&1 && [ -f "/var/www/seegap/docker-compose.yml" ]; then
          echo "ðŸ³ Docker deployment detected, restarting containers..."
          cd /var/www/seegap
          sudo docker-compose down
          sudo docker-compose up -d --build
        elif systemctl is-active --quiet nginx; then
          echo "ðŸŒ Nginx deployment detected, restarting services..."
          sudo systemctl reload nginx
          sudo systemctl restart php8.1-fpm || sudo systemctl restart php8.0-fpm || sudo systemctl restart php7.4-fpm
        else
          echo "âš ï¸ No web server detected, checking for Apache..."
          if systemctl is-active --quiet apache2; then
            sudo systemctl restart apache2
          else
            echo "ðŸ”§ Starting basic PHP server for testing..."
            cd /var/www/seegap && nohup php -S 0.0.0.0:8080 > /dev/null 2>&1 &
          fi
        fi
        
        echo "ðŸ§¹ Cleaning up temporary files..."
        rm -rf /tmp/seegap-deploy
        rm -f ~/seegap-app.tar.gz
        
        echo "âœ… Deployment completed successfully!"
        EOF
        
    - name: Upload and execute deployment script
      run: |
        echo "ðŸš€ Uploading deployment script..."
        gcloud beta compute scp deploy.sh ${{ env.GCP_VM_NAME }}:/tmp/ --zone=${{ env.GCP_ZONE }} --project=${{ env.GCP_PROJECT_ID }}
        
        echo "ðŸ”§ Executing deployment on GCP VM..."
        gcloud beta compute ssh ${{ env.GCP_VM_NAME }} --zone=${{ env.GCP_ZONE }} --project=${{ env.GCP_PROJECT_ID }} --command="chmod +x /tmp/deploy.sh && /tmp/deploy.sh"
        
    - name: Deployment Summary
      run: |
        echo "âœ… Deployment completed successfully!"
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain**: https://si.seegap.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: âœ… Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Files deployed to**: /var/www/seegap" >> $GITHUB_STEP_SUMMARY
