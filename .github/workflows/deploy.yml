name: Deploy SeeGap Application

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GCP_PROJECT_ID: eminent-subset-462023-f9
  GCP_VM_NAME: seegap-app-vm
  GCP_ZONE: europe-west1-b
  GCP_VM_IP: 34.140.57.52
  DEPLOY_PATH: /var/www/seegap

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: 'projects/179814022008/locations/global/workloadIdentityPools/github-actions-pool/providers/github-provider'
        service_account: 'github-actions-deploy@eminent-subset-462023-f9.iam.gserviceaccount.com'
        
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.GCP_PROJECT_ID }}
        
    - name: Create deployment package
      run: |
        echo "üì¶ Creating deployment package..."
        tar -czf seegap-app.tar.gz \
          --exclude='.git' \
          --exclude='.github' \
          --exclude='node_modules' \
          --exclude='*.log' \
          --exclude='uploads/logs/*' \
          --exclude='terraform' \
          --exclude='backup_*' \
          --exclude='test_*' \
          .
        
    - name: Upload application files
      run: |
        echo "üöÄ Uploading application files to GCP VM..."
        gcloud compute scp seegap-app.tar.gz ${{ env.GCP_VM_NAME }}:/tmp/ \
          --zone=${{ env.GCP_ZONE }} \
          --project=${{ env.GCP_PROJECT_ID }}
          
    - name: Upload database dump
      run: |
        echo "üìä Uploading database dump..."
        gcloud compute scp install/dump.sql ${{ env.GCP_VM_NAME }}:/tmp/ \
          --zone=${{ env.GCP_ZONE }} \
          --project=${{ env.GCP_PROJECT_ID }}
          
    - name: Deploy application
      run: |
        echo "üîß Deploying application on GCP VM..."
        gcloud compute ssh ${{ env.GCP_VM_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --project=${{ env.GCP_PROJECT_ID }} \
          --command='bash -s' << 'DEPLOY_SCRIPT'
        
        # Set up deployment directory
        sudo mkdir -p /var/www/seegap
        sudo chown $USER:$USER /var/www/seegap
        
        # Create backup of current deployment if exists
        if [ -d "/var/www/seegap/current" ]; then
          echo "üìã Creating backup of current deployment..."
          sudo cp -r /var/www/seegap/current /var/www/seegap/backup-$(date +%Y%m%d-%H%M%S)
        fi
        
        # Extract new deployment
        echo "üìÇ Extracting new deployment..."
        cd /var/www/seegap
        rm -rf new
        mkdir -p new
        cd new
        tar -xzf /tmp/seegap-app.tar.gz
        
        # Create production config
        echo "‚öôÔ∏è Creating production configuration..."
        cat > config.php << 'CONFIG_END'
        <?php
        define('DATABASE_SERVER',   'mysql');
        define('DATABASE_USERNAME', 'seegap_prod_user_2025');
        define('DATABASE_PASSWORD', 'SeeGap#Prod$2025!MySQL@Secure');
        define('DATABASE_NAME',     'seegap_production_db');
        define('SITE_URL',          'https://si.seegap.com/');
        CONFIG_END
        
        # Set proper permissions
        chmod 644 config.php
        chmod -R 755 themes/
        chmod -R 755 plugins/
        chmod -R 777 uploads/
        
        # Stop current services
        echo "üõë Stopping current services..."
        docker-compose down || true
        
        # Start MySQL service
        echo "üìä Setting up database..."
        docker-compose up -d mysql
        sleep 30
        
        # Wait for MySQL to be ready
        echo "‚è≥ Waiting for MySQL to be ready..."
        until docker-compose exec -T mysql mysqladmin ping -h"localhost" --silent; do
          echo "Waiting for MySQL..."
          sleep 5
        done
        
        # Create database and user
        echo "üì• Setting up database and user..."
        docker-compose exec -T mysql mysql -u root -p'Root#MySQL$2025!SuperSecure@GCP' -e "
        CREATE DATABASE IF NOT EXISTS seegap_production_db;
        CREATE USER IF NOT EXISTS 'seegap_prod_user_2025'@'%' IDENTIFIED BY 'SeeGap#Prod$2025!MySQL@Secure';
        GRANT ALL PRIVILEGES ON seegap_production_db.* TO 'seegap_prod_user_2025'@'%';
        FLUSH PRIVILEGES;"
        
        # Import the SQL dump
        echo "üì• Importing database dump..."
        docker-compose exec -T mysql mysql -u root -p'Root#MySQL$2025!SuperSecure@GCP' seegap_production_db < /tmp/dump.sql
        
        # Start all services
        echo "üöÄ Starting all services..."
        docker-compose up -d
        
        # Wait for services to be ready
        sleep 30
        
        # Switch to new deployment
        echo "üîÑ Switching to new deployment..."
        cd /var/www/seegap
        rm -rf current
        mv new current
        
        # Clean up
        rm -f /tmp/seegap-app.tar.gz
        rm -f /tmp/dump.sql
        
        echo "‚úÖ Deployment completed successfully!"
        DEPLOY_SCRIPT
        
    - name: Health check
      run: |
        echo "üîç Performing health check..."
        sleep 30
        
        # Check if the application is responding
        for i in {1..10}; do
          if curl -f -s https://si.seegap.com/ | grep -q "SeeGap\|login\|dashboard"; then
            echo "‚úÖ Application is responding correctly!"
            break
          else
            echo "‚è≥ Attempt $i: Application not ready yet, waiting..."
            sleep 10
          fi
          
          if [ $i -eq 10 ]; then
            echo "‚ùå Health check failed after 10 attempts"
            exit 1
          fi
        done
        
    - name: Verify database connection
      run: |
        echo "üîç Verifying database connection..."
        gcloud compute ssh ${{ env.GCP_VM_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --project=${{ env.GCP_PROJECT_ID }} \
          --command='cd /var/www/seegap/current && docker-compose exec -T mysql mysql -u seegap_prod_user_2025 -p"SeeGap#Prod$2025!MySQL@Secure" seegap_production_db -e "SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = \"seegap_production_db\";"'
        
    - name: Deployment Summary
      run: |
        echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Domain**: https://si.seegap.com" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "- **Database**: ‚úÖ Production DB Imported" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
    - name: Cleanup on failure
      if: failure()
      run: |
        echo "üîÑ Rolling back deployment due to failure..."
        gcloud compute ssh ${{ env.GCP_VM_NAME }} \
          --zone=${{ env.GCP_ZONE }} \
          --project=${{ env.GCP_PROJECT_ID }} \
          --command='bash -s' << 'ROLLBACK_SCRIPT'
        cd /var/www/seegap
        LATEST_BACKUP=$(ls -t backup-* 2>/dev/null | head -n1)
        if [ -n "$LATEST_BACKUP" ]; then
          echo "üìã Restoring from backup: $LATEST_BACKUP"
          rm -rf current
          cp -r "$LATEST_BACKUP" current
          cd current
          docker-compose up -d
        else
          echo "‚ùå No backup found for rollback"
        fi
        ROLLBACK_SCRIPT
